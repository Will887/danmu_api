name: Fork Sync (Only When Upstream Changes)

permissions:
  contents: write

on:
  schedule:
    - cron: "0 23 * * *"   # 北京时间每天 07:00
  workflow_dispatch:

concurrency:
  group: fork-sync
  cancel-in-progress: true

jobs:
  sync_with_upstream:
    name: Sync only if upstream updated
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add upstream repo
        run: |
          git remote add upstream https://github.com/huangxd-/danmu_api.git || true
          git fetch upstream

      - name: Check if upstream has new commits
        id: check
        run: |
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          LOCAL_COMMIT=$(git rev-parse origin/main)

          echo "Upstream commit: $UPSTREAM_COMMIT"
          echo "Local commit:    $LOCAL_COMMIT"

          if [ "$UPSTREAM_COMMIT" = "$LOCAL_COMMIT" ]; then
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            echo "updated=true" >> $GITHUB_OUTPUT
          fi

      - name: Sync with upstream
        if: steps.check.outputs.updated == 'true'
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4
        with:
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_sync_repo: huangxd-/danmu_api
          upstream_sync_branch: main
          target_sync_branch: main
          test_mode: false

      - name: No updates found
        if: steps.check.outputs.updated == 'false'
        run: echo "Upstream has no new commits. Skip sync."
